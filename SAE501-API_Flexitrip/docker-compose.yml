version: '3.8'

services:
  # --- BASE DE DONNÃ‰ES SQL ---
  mysql:
    image: mysql:8
    container_name: flexitrip_mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: SAE_Multi
      MYSQL_ROOT_HOST: '%'
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql

  # --- CACHE ---
  redis:
    image: redis:alpine
    container_name: flexitrip_redis
    restart: always
    ports:
      - "6379:6379"

  # --- ZOOKEEPER (NÃ©cessaire pour Kafka) ---
  zookeeper:
    image: wurstmeister/zookeeper:latest
    container_name: flexitrip_zookeeper
    restart: always
    ports:
      - "2181:2181"

  # --- KAFKA (Broker de messages) ---
  kafka:
    image: wurstmeister/kafka:latest
    container_name: flexitrip_kafka
    restart: always
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092

  # ==========================================
  # ðŸ†• MONGODB LOCAL (REMPLACE ATLAS)
  # ==========================================
  mongodb:
    image: mongo:7
    container_name: flexitrip_mongodb
    restart: always
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db

  # --- API PRINCIPALE ---
  api:
    build: .
    container_name: flexitrip_api
    restart: always
    depends_on:
      - kafka
      - mysql
      - redis
      - zookeeper
      - mongodb
    
    command: ["sh", "-c", "sleep 15 && node app.js"]
    
    environment:
      DB_USER: root
      DB_PASSWORD: root
      DB_HOST: mysql
      REDIS_HOST: redis
      REDIS_PORT: 6379
      KAFKA_BROKER: kafka:9092
      # ==========================================
      # ðŸ†• MONGODB LOCAL
      # ==========================================
      MONGO_URI: mongodb://mongodb:27017/flexitrip
      # ==========================================
      # ðŸ†• GOOGLE MAPS & AVIATIONSTACK APIs
      # ==========================================
      GOOGLE_MAPS_API_KEY: ${GOOGLE_MAPS_API_KEY}
      AVIATIONSTACK_API_KEY: ${AVIATIONSTACK_API_KEY}

    ports:
      - "17777:17777"
    
    volumes:
      - .:/app
      - /app/node_modules

volumes:
  mysql_data:
  mongodb_data: